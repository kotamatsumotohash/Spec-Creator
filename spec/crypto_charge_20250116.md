# 暗号資産チャージ機能 要件定義書

承認: Manager（プロダクトマネージャー）
承認日: 2025年1月16日

## 1. 概要
Baseチェーン上のBTC（cbBTC）またはUSDCを使用してau PAY残高にチャージできる機能。

## 2. ビジネスゴール
Ponta交換機能やスワップ機能と統合し、日本円の入金、資産運用、暗号資産の出金を一つのウォレット内で完結させることで、他のウォレットにはない独自の価値を提供する。

### KPI
| 指標 | 定義 | 目標（仮） | 計測方法 |
| --- | --- | --- | --- |
| - | ユーザーの利便性向上機能のため設定なし | - | - |

## 3. 想定ユーザーフロー
1. ウォレット画面から「au PAYにチャージ」ボタンをタップ
2. チャージ金額を選択（100円、1,000円、5,000円、10,000円、50,000円から選択、または手動入力で最大50,000円まで）
3. 使用する暗号資産を選択（cbBTCまたはUSDCから一方を選択）
4. 確認画面で金額、使用暗号資産額、手数料を確認
5. 30秒以内に「確定」ボタンをタップ
6. チャージ完了画面が表示される
7. 「履歴を見る」リンクから履歴画面へ遷移可能

## 4. UI
### 画面1：チャージ金額選択画面
- 月間利用可能額の表示（例：「今月の残り利用可能額：30,000円」）
- チャージ金額選択ボタン（100円、1,000円、5,000円、10,000円、50,000円）
- 手動入力フィールド（最大50,000円）
- 使用する暗号資産の選択（cbBTC/USDCラジオボタン）
- 選択した暗号資産の現在残高表示
- 「次へ」ボタン

### 画面2：確認画面
- チャージ金額
- 選択した暗号資産種別
- 必要な暗号資産額（2.5%手数料込み）
- 現在のレート表示
- 残り時間カウントダウン（30秒）
- 「確定」「キャンセル」ボタン

### 画面3：完了画面
- チャージ完了メッセージ
- チャージ金額
- au PAY残高
- 「履歴を見る」リンク
- 「ウォレットに戻る」ボタン

### エラー画面一覧
- KYC未完了ダイアログ
- 月間上限到達エラー
- クオート期限切れ（ウォレット画面へ遷移）
- 残高不足エラー
- ネットワークエラー
- トランザクション失敗エラー

## 5. 機能要求
### 機能詳細
| 優先度 | 項目 | 要求 |
| --- | --- | --- |
| Must | チャージ金額選択 | 100円〜50,000円の範囲で金額を選択・入力できる |
| Must | 暗号資産選択 | cbBTCまたはUSDCから一方を選択可能 |
| Must | 残高表示 | 選択した暗号資産の現在残高をリアルタイム表示 |
| Must | KYC確認 | KYC済みユーザーのみ利用可能、未完了の場合はダイアログ表示 |
| Must | 月間上限管理 | 月間50,000円までのチャージ制限、日本時間毎月1日00:00にリセット |
| Must | 残り利用可能額表示 | 月間の残り利用可能額を明確に表示 |
| Must | クオート管理 | 30秒の有効期限付きレート提示、API応答は3秒以内 |
| Must | 手数料計算 | チャージ時に2.5%の手数料を暗号資産額に上乗せ |
| Must | チャージ履歴 | 履歴機能内にチャージ履歴を表示、完了画面から直接アクセス可能 |
| Must | トランザクション管理 | 失敗時は自動ロールバック、ステータスを監査ログに記録 |
| Must | パフォーマンス | 画面遷移2秒以内、API応答3秒以内、タイムアウト時は最大3回リトライ |
| Could | 通知機能 | チャージ完了時のプッシュ通知 |
| Won't | 定期チャージ | 自動定期チャージ機能 |

### エラー詳細
| エラー種別 | 発生条件 | 表示メッセージ | ユーザーアクション | システム動作 |
| --- | --- | --- | --- | --- |
| KYC未完了 | KYC未完了ユーザーがチャージボタンをタップ | 「au PAYチャージにはKYC認証が必要です」 | KYC手続きへ遷移 or キャンセル | ダイアログ表示 |
| 月間上限到達 | 月間チャージ額が50,000円に到達 | 「今月のチャージ上限（50,000円）に達しました。翌月1日にリセットされます」 | OK確認 | エラーダイアログ表示 |
| クオート期限切れ | 30秒経過後に確定ボタンタップ | 「レートの有効期限が切れました。もう一度お試しください」 | OK確認 | ウォレット画面へ遷移 |
| 残高不足 | 暗号資産残高が必要額未満 | 「選択した暗号資産の残高が不足しています」 | OK確認 | エラーダイアログ表示 |
| ネットワークエラー | 通信エラー発生時 | 「通信エラーが発生しました。しばらくしてからお試しください」 | OK確認 | エラーダイアログ表示、3回リトライ後表示 |
| トランザクション失敗 | ブロックチェーン処理失敗 | 「処理に失敗しました。しばらくしてからお試しください」 | OK確認 | 自動ロールバック、監査ログ記録 |

## 6. 運用
### 運用頻度
- 日次：エラー監視、トランザクション監視
- 月次：利用状況レポート作成

### 運用フロー
1. 日次でチャージ金額・件数・エラー率を監視
2. エラー発生時はアラート通知→調査→対応
3. 月次で利用状況レポートを作成
4. 監査ログの定期確認（週次）

### 運用コスト
- 監視ツール利用料
- カスタマーサポート対応工数
- ログストレージ費用

## 7. セキュリティ/コンプライアンス等の要求
- 資金決済法に基づく月間上限50,000円の制限実装
- KYC認証済みユーザーのみに機能を限定
- トランザクション署名の安全な実装
- チャージ履歴の適切な保管（最低1年間）
- 月間上限は日本時間（JST）基準で管理
- 監査ログ記録項目：ユーザーID、日時、チャージ金額、使用暗号資産、トランザクションID、成功/失敗ステータス
- APIレート制限：1ユーザーあたり10回/分

## 8. Devチームへ引き継ぎする未決定事項
| 項目 | 補足 |
| --- | --- |
| レート取得API | cbBTC/USDCの円換算レート取得方法、プロバイダー選定 |
| トランザクション処理 | Baseチェーン上でのトランザクション実装詳細、ガス代の扱い |
| 監査ログ保管先 | ログの保管先システムとアクセス権限 |

## 9. 今後のTodo（Biz）
- [ ] レート提供元の選定
- [ ] エラー時のカスタマーサポート対応フロー策定
- [ ] 監査ログアクセス権限の策定